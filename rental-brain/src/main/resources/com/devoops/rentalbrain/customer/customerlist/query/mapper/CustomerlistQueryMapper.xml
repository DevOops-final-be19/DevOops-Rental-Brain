<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.devoops.rentalbrain.customer.customerlist.query.mapper.CustomerlistQueryMapper">

    <sql id="searchCriteria">
        WHERE A.IS_DELETED = 'N'
        <if test="dto.keyword != null and dto.keyword != ''">
            AND (
            A.NAME LIKE CONCAT('%', #{dto.keyword}, '%') OR
            A.IN_CHARGE LIKE CONCAT('%', #{dto.keyword}, '%') OR
            REPLACE(A.CALL_NUM, '-', '') LIKE CONCAT('%', #{dto.keyword}, '%') OR
            REPLACE(A.PHONE, '-', '') LIKE CONCAT('%', #{dto.keyword}, '%') OR
            REPLACE(A.BUSINESS_NUM, '-', '') LIKE CONCAT('%', #{dto.keyword}, '%')
            )
        </if>
        <if test="dto.segments != null and dto.segments.size() > 0">
            AND (
            <foreach collection="dto.segments" item="seg" separator=" OR ">
                C.NAME LIKE CONCAT('%', #{seg}, '%')
            </foreach>
            )
        </if>
    </sql>

    <select id="selectCustomerList" resultType="com.devoops.rentalbrain.customer.common.CustomerDTO">
        SELECT
               A.ID
             , A.CUSTOMER_CODE
             , A.NAME
             , A.IN_CHARGE
             , A.DEPT
             , A.CALL_NUM
             , A.PHONE
             , A.EMAIL
             , A.BUSINESS_NUM
             , A.ADDR
             , A.LAST_TRANSACTION
             , A.FIRST_CONTRACT_DATE
             , A.MEMO
             , A.STAR
             , A.IS_DELETED
             , B.NAME AS CHANNEL_NAME
             , C.NAME AS SEGMENT_NAME
          FROM customer A
          LEFT JOIN channel B ON A.CHANNEL_ID = B.ID
          LEFT JOIN segment C ON A.SEGMENT_ID = C.ID
        <include refid="searchCriteria"/>
        ORDER BY A.ID DESC
        LIMIT #{dto.amount} OFFSET #{dto.offset}
    </select>

    <select id="countCustomer" resultType="int">
        SELECT COUNT(*)
          FROM customer A
          LEFT JOIN channel B ON A.CHANNEL_ID = B.ID
          LEFT JOIN segment C ON A.SEGMENT_ID = C.ID
        <include refid="searchCriteria"/>
    </select>

    <select id="selectKpi" resultType="com.devoops.rentalbrain.customer.customerlist.query.dto.CustomerKpiDTO">
        SELECT
               COUNT(*) as totalCount,
               COUNT(CASE WHEN C.NAME LIKE '%VIP%' THEN 1 END) as vipCount,
               COUNT(CASE WHEN C.NAME LIKE '%위험%' OR C.NAME LIKE '%이탈%' THEN 1 END) as riskCount,
               COUNT(CASE WHEN C.NAME LIKE '%블랙%' THEN 1 END) as blacklistCount,
               (COUNT(CASE WHEN C.NAME LIKE '%VIP%' THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0)) as vipRate
          FROM customer A
                 LEFT JOIN channel B ON A.CHANNEL_ID = B.ID
                 LEFT JOIN segment C ON A.SEGMENT_ID = C.ID
         WHERE A.IS_DELETED = 'N'
    </select>

    <select id="selectCustomerById" resultType="com.devoops.rentalbrain.customer.common.CustomerDTO">
        SELECT
               A.ID
             , A.CUSTOMER_CODE
             , A.NAME
             , A.IN_CHARGE
             , A.DEPT
             , A.CALL_NUM
             , A.PHONE
             , A.EMAIL
             , A.BUSINESS_NUM
             , A.ADDR
             , A.LAST_TRANSACTION
             , A.FIRST_CONTRACT_DATE
             , A.MEMO
             , A.STAR
             , A.IS_DELETED
             , B.NAME AS CHANNEL_NAME
             , C.NAME AS SEGMENT_NAME
          FROM customer A
          LEFT JOIN channel B ON A.CHANNEL_ID = B.ID
          LEFT JOIN segment C ON A.SEGMENT_ID = C.ID
         WHERE A.ID = #{id}
    </select>

    <resultMap id="CustomerDetailMap" type="com.devoops.rentalbrain.customer.customerlist.query.dto.CustomerDetailResponseDTO">
        <id property="id" column="ID"/>
        <result property="customerCode" column="CUSTOMER_CODE"/>
        <result property="name" column="NAME"/>
        <result property="inCharge" column="IN_CHARGE"/>
        <result property="dept" column="DEPT"/>
        <result property="callNum" column="CALL_NUM"/>
        <result property="phone" column="PHONE"/>
        <result property="email" column="EMAIL"/>
        <result property="businessNum" column="BUSINESS_NUM"/>
        <result property="addr" column="ADDR"/>
        <result property="memo" column="MEMO"/>
        <result property="segmentName" column="SEGMENT_NAME"/>
        <result property="lastTransaction" column="LAST_TRANSACTION"/>

        <collection property="contractList" column="id" select="selectContractsByCustomerId"/>
        <collection property="supportList" column="id" select="selectSupportsByCustomerId"/>
        <collection property="asList" column="id" select="selectAsByCustomerId"/>
    </resultMap>

    <select id="selectCustomerDetail" resultMap="CustomerDetailMap">
        SELECT
               A.ID
             , A.CUSTOMER_CODE
             , A.NAME
             , A.IN_CHARGE
             , A.DEPT
             , A.CALL_NUM
             , A.PHONE
             , A.EMAIL
             , A.BUSINESS_NUM
             , A.ADDR
             , A.LAST_TRANSACTION
             , A.FIRST_CONTRACT_DATE
             , A.MEMO
             , A.STAR
             , A.IS_DELETED
             , B.NAME AS CHANNEL_NAME
             , C.NAME AS SEGMENT_NAME
          FROM customer A
          LEFT JOIN channel B ON A.CHANNEL_ID = B.ID
          LEFT JOIN segment C ON A.SEGMENT_ID = C.ID
         WHERE A.ID = #{id}
    </select>

    <select id="selectSupportsByCustomerId" resultType="com.devoops.rentalbrain.customer.customersupport.command.dto.CustomersupportDTO">
        SELECT A.*
          FROM customer_support A
         WHERE A.CUM_ID = #{id}
         ORDER BY A.CREATE_DATE DESC
    </select>

    <select id="selectContractsByCustomerId" resultType="com.devoops.rentalbrain.business.contract.query.dto.ContractSummaryDTO">
        SELECT A.*
          FROM contract A
         WHERE A.CUM_ID = #{id}
         ORDER BY A.START_DATE DESC
    </select>

    <select id="selectAsByCustomerId" resultType="com.devoops.rentalbrain.product.maintenance.query.dto.AfterServiceDTO">
        SELECT A.*
          FROM after_service A
         WHERE A.CUM_ID = #{id}
         ORDER BY A.DUE_DATE DESC
    </select>

</mapper>